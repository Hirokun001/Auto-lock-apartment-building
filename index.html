<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>オートロックマンション 地図＋スプレッドシート</title>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* ① 現在地ボタン（スマホでも押しやすいサイズ） */
    #getLocationBtn {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 9999;
      padding: 16px 24px;
      background: #4285F4;
      color: white;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #getLocationBtn:hover {
      background: #5A95F9;
    }
  </style>
</head>
<body>

  <!-- ① 追加：現在地を取得ボタン -->
  <button id="getLocationBtn">現在地を取得</button>

  <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBaxgKJTUw1-0gl1pks-ATIc6iw1HITZyg&callback=initMap" async defer></script>

  <script>
    /* -------------------------------------------
       マンションデータ（あなたの元ファイルそのまま）
       ------------------------------------------- */
    const apartments = [
      {
        name: "プレサンスロジェ草津シエル",
        position: { lat: 35.02332033360808, lng: 135.96861511597268 },
        sheetUrl: null,
        active: false
      },
      {
        name: "シルクトレーテA棟",
        position: { lat: 35.0073924, lng: 135.9740855 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1NPxVpgBONxBvbza5W7wbYnQGInP1dRr-c3fKYpAnGe0/edit?usp=sharing",
        active: true
      },
      {
        name: "シルクトレーテB棟",
        position: { lat: 35.0075715, lng: 135.974253 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1o772GZpl8Uu8GsAIyXoScJszCJFQN5Hc18ifRReWmkg/edit?usp=sharing",
        active: true
      },
      {
        name: "ガーデンハイツヤマキ",
        position: { lat: 35.0042782, lng: 135.9707617 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1cIv7xgrO0vkcXxxGeviPxx05NkKw_EhfEkCOwQ3uhlA/edit?usp=sharing",
        active: true
      },
      {
        name: "クランボナール",
        position: { lat: 35.0040314, lng: 135.9714115 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1_XvlOmBBMgIrarYD_quGHwGsWwHq9bNF71mX8MCm-Ec/edit?usp=sharing",
        active: true
      },
      {
        name: "アルタ青地ビュー",
        position: { lat: 35.0083318, lng: 135.9750119 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1rdzT_NRjPwPjWQynSrSdYqGSgANFE4qQpfyBHL2Bo_M/edit?usp=sharing",
        active: true
      },
      {
        name: "EL ORIENTE2",
        position: { lat: 35.0135221, lng: 135.9716834 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1b7Tml1T_bFOVJlxdKGRrZE8kJKPFej1N_rSfpcd6kK4/edit?usp=sharing",
        active: true
      },
      {
        name: "Baum Dorf",
        position: { lat: 35.0061945, lng: 135.9606194 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1qVp3wMr0_plAG91-EpANvB-9UNTOww-WhmRZBwOTF8E/edit?usp=sharing",
        active: true
      },
      {
        name: "デン・エデン",
        position: { lat: 35.0069946, lng: 135.9663906 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1zQJhR_R02iHvyNBdOLRvBEornEvOivDVYNV35SY2QBU/edit?usp=sharing",
        active: true
      },
      {
        name: "ミニオン一期一会",
        position: { lat: 34.9911528, lng: 135.9644665 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/12ZU7wTm7n8IS4WIZwH7G4U9mBJnPlh59QOJlJ96vCgM/edit?usp=sharing",
        active: true
      },
      {
        name: "パルト・プロムナードⅠ",
        position: { lat: 35.0099677, lng: 135.9655099 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1Z0DdHhCUaoCQRBgKckEN8bohvAyx5Zfg_6Awqn8y3_s/edit?usp=sharing",
        active: true
      },
      {
        name: "パルト・プロムナードⅡ",
        position: { lat: 35.0100723, lng: 135.9654017 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1-FAask5Li3iYGb1UUjKhDvCf4UKUAX3vxtxLV73yFIs/edit?usp=sharing",
        active: true
      },
      {
        name: "EL ORIENTE",
        position: { lat: 35.0137968, lng: 135.9714161 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1Pv1OciAaztZCIBkIyCxO46pHIErr5dWZJnRgCB00NcI/edit?usp=sharing",
        active: true
      },
      {
        name: "コスモ草津(夜)",
        position: { lat: 35.0173991, lng: 135.9598398 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1o4RwGf_t96GtdFDp7jNkVDMSFr22Vhz3-ScqZ9wOoDc/edit?usp=sharing",
        active: true
      },
      {
        name: "草津パークホームズ",
        position: { lat: 35.0122945, lng: 135.9559939 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1ThqZh2LcPcwXBIP630vr3b_ZCR26-npxVy_-347ORRY/edit?usp=sharing",
        active: true
      },
      {
        name: "ココスモ草津Ⅱ (夜)",
        position: { lat: 35.0176379, lng: 135.9587089 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1M8uhi42_NvaVrYCA59XLDuCrLYcn5t8XlrLv-g8-dEI/edit?usp=sharing",
        active: true
      },
      {
        name: "リベルテ草津",
        position: { lat: 35.018516, lng: 135.9591753 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1bVCC-vuvmNAqsKfs3mvRXWGhKCE7XHeAFeJ_nwWRzWA/edit?usp=sharing",
        active: true
      },
      {
        name: "アコール東草津",
        position: { lat: 35.0157344, lng: 135.9690205 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1rAz961SDxo0Q028rR0fBV8nyPq5A1RQeawZE34nZJFA/edit?usp=sharing",
        active: true
      },
      {
        name: "Casa raffine草津",
        position: { lat: 35.0151292, lng: 135.9645046 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1WGYDKJQj28mxtCNOBP3MVInTkD0yVOvfirfHZkh6ZHk/edit?usp=sharing",
        active: true
      }
    ];


    /* -------------------------------------------
       Google シート CSV 化
       ------------------------------------------- */
    function convertSheetToCsvUrl(sheetUrl) {
      const m = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!m) return null;
      return `https://docs.google.com/spreadsheets/d/${m[1]}/export?format=csv`;
    }

    /* -------------------------------------------
       スプレッドシートから訪問状況を取得
       ------------------------------------------- */
    async function fetchVisitStatus(apt) {
      if (!apt.sheetUrl) return { color: "lime" }; // 黄緑（デフォルト）

      const csvUrl = convertSheetToCsvUrl(apt.sheetUrl);

      try {
        const res = await fetch(csvUrl);
        const text = await res.text();

        const rows = text.trim().split("\n").map(r => r.split(","));
        const header = rows[0];

        const visitCol = header.indexOf("訪問状況");
        const meetCol = header.indexOf("会えた");

        let total = 0;
        let firstCount = 0;
        let meetCount = 0;

        for (let i = 1; i < rows.length; i++) {
          const v = rows[i][visitCol];
          const m = rows[i][meetCol];
          total++;
          if (v === "一回目") firstCount++;
          if (m === "会えた") meetCount++;
        }

        if (total > 0 && firstCount === total) return { color: "yellow" };
        if (meetCount / total >= 0.5) return { color: "red" };

        return { color: "lime" };
      } catch {
        return { color: "lime" };
      }
    }

    /* -------------------------------------------
       マーカー追加（動的カラー＋黄緑デフォルト）
       ------------------------------------------- */
    async function addApartmentMarkers() {
      for (const apt of apartments) {
        const status = await fetchVisitStatus(apt);

        let fillColor = "#7ED957"; // デフォルト黄緑
        if (status.color === "yellow") fillColor = "#FBC02D";
        if (status.color === "red") fillColor = "#E53935";

        const pathData =
        "M1662.11,944.38c0-306.13-248.18-554.32-554.32-554.32-29.74,0-58.89,2.36-87.35,6.92-264.൦";

        const icon = {
          path: pathData,
          fillColor: fillColor,
          fillOpacity: 0.95,
          strokeColor: "white",
          strokeWeight: 2,
          scale: 0.05,
          anchor: new google.maps.Point(831, 1193)
        };

        const marker = new google.maps.Marker({
          position: apt.position,
          map: map,
          title: apt.name,
          icon: icon
        });

        if (apt.sheetUrl) {
          marker.addListener("click", () => window.open(apt.sheetUrl, "_blank"));
        }
      }
    }

    /* -------------------------------------------
       Google Map 初期化
       ------------------------------------------- */
    let map, userMarker, shadowMarker;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: apartments[0].position,
        zoom: 16
      });

      addApartmentMarkers();  // マンションマーカー表示
    }

    /* -------------------------------------------
       ① 現在地ボタン → クリック時に位置取得
       ------------------------------------------- */
    document.getElementById("getLocationBtn").onclick = () => {
      if (!navigator.geolocation) {
        alert("このブラウザは現在地取得に対応していません。");
        return;
      }

      navigator.geolocation.getCurrentPosition(pos => {
        const userPos = {
          lat: pos.coords.latitude,
          lng: pos.coords.longitude
        };

        map.setCenter(userPos);

        // 影マーカー
        shadowMarker = new google.maps.Marker({
          position: userPos,
          map: map,
          zIndex: 1,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 28,
            fillColor: "black",
            fillOpacity: 0.25,
            strokeWeight: 0
          }
        });

        // 本体マーカー
        userMarker = new google.maps.Marker({
          position: userPos,
          map: map,
          zIndex: 2,
          icon: {
            path: google.maps.SymbolPath.CIRCLE,
            scale: 20,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeWeight: 3,
            strokeColor: "white"
          }
        });

        /* ③ ゆっくり自然なアニメーション */
        let grow = true;
        let size = 20;

        setInterval(() => {
          size += grow ? 0.08 : -0.08;

          if (size >= 23) grow = false;
          if (size <= 20) grow = true;

          userMarker.setIcon({
            path: google.maps.SymbolPath.CIRCLE,
            scale: size,
            fillColor: "#4285F4",
            fillOpacity: 1,
            strokeWeight: 3,
            strokeColor: "white"
          });

        }, 70);
      },
      err => alert("現在地を取得できませんでした。権限をご確認ください。")
      );
    };

  </script>
</body>
</html>
