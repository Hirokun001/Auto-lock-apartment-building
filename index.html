<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>オートロックマンション 地図＋スプレッドシート</title>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }
  </style>
</head>
<body>
  <div id="map"></div>
  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBaxgKJTUw1-0gl1pks-ATIc6iw1HITZyg&callback=initMap" async defer></script>

<script>
    const DEFAULT_GID = "1854135294";
    let map;
    let apartmentMarkerObjects = [];
    let userMarker = null;
    let shadowMarker = null;

    const INITIAL_CENTER = { lat: 35.012, lng: 135.965 };

    function getMarkerScale() {
      const w = window.innerWidth;
      // 【スマホ】
      if (w <= 600) return { apt: 0.07, user: 28 };
      // 【タブレット】
      if (w <= 1024) return { apt: 0.040, user: 12 };
      // 【PC・その他】
      return { apt: 0.040, user: 12 };
    }

    const apartments = [
      { name: "プレサンスロジェ草津シエル", position: { lat: 35.02332033360808, lng: 135.96861511597268 }, sheetUrl: null, active: false },
      { name: "シルクトレーテA棟", position: { lat: 35.0073924, lng: 135.9740855 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1NPxVpgBONxBvbza5W7wbYnQGInP1dRr-c3fKYpAnGe0/edit?usp=sharing", active: true },
      { name: "シルクトレーテB棟", position: { lat: 35.0075715, lng: 135.974253 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1o772GZpl8Uu8GsAIyXoScJszCJFQN5Hc18ifRReWmkg/edit?usp=sharing", active: true },
      { name: "ガーデンハイツヤマキ", position: { lat: 35.0042782, lng: 135.9707617 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1cIv7xgrO0vkcXxxGeviPxx05NkKw_EhfEkCOwQ3uhlA/edit?usp=sharing", active: true },
      { name: "クランボナール", position: { lat: 35.0040314, lng: 135.9714115 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1_XvlOmBBMgIrarYD_quGHwGsGswHq9bNF71mX8MCm-Ec/edit?usp=sharing", active: true },
      { name: "アルタ青地ビュー", position: { lat: 35.0083318, lng: 135.9750119 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1rdzT_NRjPwPjWQynSrSdYqGSgANFE4qQpfyBHL2Bo_M/edit?usp=sharing", active: true },
      { name: "EL ORIENTE2", position: { lat: 35.0135221, lng: 135.9716834 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1b7Tml1T_bFOVJlxdKGRrZE8kJKPFej1N_rSfpcd6kK4/edit?usp=sharing", active: true },
      { name: "Baum Dorf", position: { lat: 35.0061945, lng: 135.9606194 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1qVp3wMr0_plAG91-EpANvB-9UNTOww-WhmRZBwOTF8E/edit?usp=sharing", active: true },
      { name: "デン・エデン", position: { lat: 35.0069946, lng: 135.9663906 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1zQJhR_R02iHvyNBdOLRvBEornEvOivDVYNV35SY2QBU/edit?usp=sharing", active: true },
      { name: "ミニオン一期一会", position: { lat: 34.9911528, lng: 135.9644665 }, sheetUrl: "https://docs.google.com/spreadsheets/d/12ZU7wTm7n8IS4WIZwH7G4U9mBJnPlh59QOJlJ96vCgM/edit?usp=sharing", active: true },
      { name: "パルト・プロムナードⅠ", position: { lat: 35.0099677, lng: 135.9655099 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Z0DdHhCUaoCQRBgKckEN8bohvAyx5Zfg_6Awqn8y3_s/edit?usp=sharing", active: true },
      { name: "パルト・プロムナードⅡ", position: { lat: 35.0100723, lng: 135.9654017 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1-FAask5Li3iYGb1UUjKhDvCf4UKUAX3vxtxLV73yFIs/edit?usp=sharing", active: true },
      { name: "EL ORIENTE", position: { lat: 35.0137968, lng: 135.9714161 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1Pv1OciAaztZCIBkIyCxO46pHIErr5dWZJnRgCB00NcI/edit?usp=sharing", active: true },
      { name: "コスモ草津(夜)", position: { lat: 35.0173991, lng: 135.9598398 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1o4RwGf_t96GtdFDp7jNkVDMSFr22Vhz3-ScqZ9wOoDc/edit?usp=sharing", active: true },
      { name: "草津パークホームズ", position: { lat: 35.0122945, lng: 135.9559939 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1ThqZh2LcPcwXBIP630vr3b_ZCR26-npxVy_-347ORRY/edit?usp=sharing", active: true },
      { name: "ココスモ草津Ⅱ (夜)", position: { lat: 35.0176379, lng: 135.9587089 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1M8uhi42_NvaVrYCA59XLDuCrLYcn5t8XlrLv-g8-dEI/edit?usp=sharing", active: true },
      { name: "リベルテ草津", position: { lat: 35.018516, lng: 135.9591753 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1bVCC-vuvmNAqsKfs3mvRXWGhKCE7XHeAFeJ_nwWRzWA/edit?usp=sharing", active: true },
      { name: "アコール東草津", position: { lat: 35.0157344, lng: 135.9690205 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1rAz961SDxo0Q028rR0fBV8nyPq5A1RQeawZE34nZJFA/edit?usp=sharing", active: true },
      { name: "Casa raffine草津", position: { lat: 35.0151292, lng: 135.9645046 }, sheetUrl: "https://docs.google.com/spreadsheets/d/1WGYDKJQj28mxtCNOBP3MVInTkD0yVOvfirfHZkh6ZHk/edit?usp=sharing", active: true }
    ];

    function convertSheetToCsvUrl(sheetUrl) {
      const m = sheetUrl.match(/\/spreadsheets\/d\/([a-zA-Z0-9-_]+)/);
      if (!m) return null;
      const sheetId = m[1];
      const gidMatch = sheetUrl.match(/gid=([0-9]+)/);
      const gid = gidMatch ? gidMatch[1] : DEFAULT_GID; 
      return `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
    }

    async function fetchVisitStatus(apt) {
      if (!apt.active || !apt.sheetUrl) return { color: "default" };
      try {
        const res = await fetch(convertSheetToCsvUrl(apt.sheetUrl));
        const text = await res.text();
        const rows = text.replace(/\r/g, "").trim().split("\n").map(r => r.split(","));
        let totalRooms = 0, enteredCount = 0;
        for (let i = 3; i < rows.length; i++) {
          const room = rows[i][0]?.trim(), visit = rows[i][1]?.trim();
          if (!room && !visit) break; 
          totalRooms++; if (visit) enteredCount++;
        } 
        const ratio = enteredCount / totalRooms;
        if (ratio >= 1.0) return { color: "red" };
        if (ratio >= 0.5) return { color: "yellow" };
        return { color: "default" };
      } catch (e) { return { color: "default" }; }
    }

    async function addApartmentMarkers() {
      const statusResults = await Promise.all(apartments.map(apt => fetchVisitStatus(apt)));
      const scales = getMarkerScale();
      apartments.forEach((apt, i) => {
        let fillColor = !apt.active ? "#808080" : (statusResults[i].color === "red" ? "#E53935" : (statusResults[i].color === "yellow" ? "#FBC02D" : "#00A0A0"));
        const marker = new google.maps.Marker({
          position: apt.position,
          map: map,
          title: apt.name,
          icon: {
            path: "M1662.11,944.38c0-306.13-248.18-554.32-554.32-554.32-29.74,0-58.89,2.36-87.35,6.92-264.64,41.86-466.93,271.01-466.93,547.4,0,85.15,19.19,165.84,53.57,237.93,15.53,32.7,34.27,63.56,55.63,92.33h-.11l445.23,590.94,441.56-586.19h-.07c70.74-93.08,112.79-209.13,112.79-335.02ZM1107.8,1193.08c-99.14,0-184.7-57.99-224.65-141.94-15.45-32.36-24.06-68.57-24.06-106.77,0-124.05,90.76-226.86,209.54-245.64,12.76-2.06,25.85-3.11,39.17-3.11,137.37,0,248.75,111.37,248.75,248.75s-111.37,248.71-248.75,248.71Z",
            fillColor: fillColor, fillOpacity: 0.95, strokeColor: "white", strokeWeight: 2, scale: scales.apt, anchor: new google.maps.Point(831, 1535)
          }
        });
        if (apt.active && apt.sheetUrl) marker.addListener("click", () => window.open(apt.sheetUrl, "_blank"));
        apartmentMarkerObjects.push(marker);
      });
    }

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), { center: INITIAL_CENTER, zoom: 16 });
      addApartmentMarkers();

      if (navigator.geolocation) {
        // watchPosition に変更して継続的に取得を試みる
        navigator.geolocation.watchPosition(
          position => {
            const userPos = { lat: position.coords.latitude, lng: position.coords.longitude };
            const scales = getMarkerScale();
            
            // 滋賀県周辺か判定（範囲を少し広げました）
            const isNearShiga = (userPos.lat > 34.5 && userPos.lat < 35.5 && userPos.lng > 135.5 && userPos.lng < 136.5);

            if (!userMarker) {
              shadowMarker = new google.maps.Marker({
                position: userPos, map: map, zIndex: 1,
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: scales.user * 1.4, fillColor: "black", fillOpacity: 0.2, strokeWeight: 0 }
              });
              userMarker = new google.maps.Marker({
                position: userPos, map: map, zIndex: 2, title: "現在地",
                icon: { path: google.maps.SymbolPath.CIRCLE, scale: scales.user, fillColor: "#4285F4", fillOpacity: 1, strokeWeight: 2, strokeColor: "white" }
              });
              map.setCenter(userPos);
            } else {
              userMarker.setPosition(userPos);
              shadowMarker.setPosition(userPos);
            }
          },
          error => {
            // エラー時、iPadで何が起きているか確認するためのアラート
            let msg = "";
            switch(error.code) {
              case 1: msg = "位置情報の利用が許可されていません。設定を確認してください。"; break;
              case 2: msg = "位置情報の取得に失敗しました。電波の良い場所で試してください。"; break;
              case 3: msg = "タイムアウトしました。"; break;
            }
            if(msg) console.warn(msg);
          },
          { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
        );
      } else {
        alert("お使いのブラウザは位置情報に対応していません。");
      }

      // アニメーション
      setInterval(() => {
              if (!userMarker) return;
              
              // 現在の画面サイズに基づいた基準サイズを取得
              const base = getMarkerScale().user;
              let s = userMarker.getIcon().scale;
              
              // growing フラグの管理
              if (this.growing === undefined) this.growing = true;

              if (this.growing) {
                s += 0.3; // 拡大スピードを少しアップ
                if (s >= base * 1.3) this.growing = false; // 最大 1.3倍まで拡大
              } else {
                s -= 0.3;
                if (s <= base) this.growing = true; // 基準サイズまで縮小
              }

              const icon = userMarker.getIcon();
              icon.scale = s;
              userMarker.setIcon(icon);
            }, 100);

      window.addEventListener('resize', () => {
        const s = getMarkerScale();
        apartmentMarkerObjects.forEach(m => { const i = m.getIcon(); i.scale = s.apt; m.setIcon(i); });
        if (userMarker) { const i = userMarker.getIcon(); i.scale = s.user; userMarker.setIcon(i); }
      });
    }
  </script>
</body>
</html>
