<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>ã‚ªãƒ¼ãƒˆãƒ­ãƒƒã‚¯ãƒãƒ³ã‚·ãƒ§ãƒ³ åœ°å›³ï¼‹ã‚¹ãƒ—ãƒ¬ãƒƒãƒ‰ã‚·ãƒ¼ãƒˆ</title>
  <style>
    body, html { margin:0; padding:0; height:100%; }
    #map { width:100%; height:100%; }

    /* â‘  ç¾åœ¨åœ°ãƒœã‚¿ãƒ³ï¼ˆã‚¹ãƒãƒ›ã§ã‚‚æŠ¼ã—ã‚„ã™ã„ã‚µã‚¤ã‚ºï¼‰ */
    #getLocationBtn {
      position: absolute;
      top: 12px;
      left: 12px;
      z-index: 9999;
      padding: 16px 24px;
      background: #4285F4;
      color: white;
      font-size: 20px;
      font-weight: bold;
      border: none;
      border-radius: 12px;
      cursor: pointer;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #getLocationBtn:hover {
      background: #5A95F9;
    }
  </style>
</head>
<body>

  <!-- â‘  è¿½åŠ ï¼šç¾åœ¨åœ°ã‚’å–å¾—ãƒœã‚¿ãƒ³ -->
  <button id="getLocationBtn">ç¾åœ¨åœ°ã‚’å–å¾—</button>

  <div id="map"></div>

  <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyBaxgKJTUw1-0gl1pks-ATIc6iw1HITZyg&callback=initMap" async defer></script>

  <script>
    /* -------------------------------------------
       ãƒãƒ³ã‚·ãƒ§ãƒ³ãƒ‡ãƒ¼ã‚¿ï¼ˆã‚ãªãŸã®å…ƒãƒ•ã‚¡ã‚¤ãƒ«ãã®ã¾ã¾ï¼‰
       ------------------------------------------- */
    const apartments = [
      {
        name: "ãƒ—ãƒ¬ã‚µãƒ³ã‚¹ãƒ­ã‚¸ã‚§è‰æ´¥ã‚·ã‚¨ãƒ«",
        position: { lat: 35.02332033360808, lng: 135.96861511597268 },
        sheetUrl: null,
        active: false
      },
      {
        name: "ã‚·ãƒ«ã‚¯ãƒˆãƒ¬ãƒ¼ãƒ†Aæ£Ÿ",
        position: { lat: 35.0073924, lng: 135.9740855 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1NPxVpgBONxBvbza5W7wbYnQGInP1dRr-c3fKYpAnGe0/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚·ãƒ«ã‚¯ãƒˆãƒ¬ãƒ¼ãƒ†Bæ£Ÿ",
        position: { lat: 35.0075715, lng: 135.974253 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1o772GZpl8Uu8GsAIyXoScJszCJFQN5Hc18ifRReWmkg/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚¬ãƒ¼ãƒ‡ãƒ³ãƒã‚¤ãƒ„ãƒ¤ãƒã‚­",
        position: { lat: 35.0042782, lng: 135.9707617 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1cIv7xgrO0vkcXxxGeviPxx05NkKw_EhfEkCOwQ3uhlA/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚¯ãƒ©ãƒ³ãƒœãƒŠãƒ¼ãƒ«",
        position: { lat: 35.0040314, lng: 135.9714115 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1_XvlOmBBMgIrarYD_quGHwGsWwHq9bNF71mX8MCm-Ec/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚¢ãƒ«ã‚¿é’åœ°ãƒ“ãƒ¥ãƒ¼",
        position: { lat: 35.0083318, lng: 135.9750119 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1rdzT_NRjPwPjWQynSrSdYqGSgANFE4qQpfyBHL2Bo_M/edit?usp=sharing",
        active: true
      },
      {
        name: "EL ORIENTE2",
        position: { lat: 35.0135221, lng: 135.9716834 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1b7Tml1T_bFOVJlxdKGRrZE8kJKPFej1N_rSfpcd6kK4/edit?usp=sharing",
        active: true
      },
      {
        name: "Baum Dorf",
        position: { lat: 35.0061945, lng: 135.9606194 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1qVp3wMr0_plAG91-EpANvB-9UNTOww-WhmRZBwOTF8E/edit?usp=sharing",
        active: true
      },
      {
        name: "ãƒ‡ãƒ³ãƒ»ã‚¨ãƒ‡ãƒ³",
        position: { lat: 35.0069946, lng: 135.9663906 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1zQJhR_R02iHvyNBdOLRvBEornEvOivDVYNV35SY2QBU/edit?usp=sharing",
        active: true
      },
      {
        name: "ãƒŸãƒ‹ã‚ªãƒ³ä¸€æœŸä¸€ä¼š",
        position: { lat: 34.9911528, lng: 135.9644665 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/12ZU7wTm7n8IS4WIZwH7G4U9mBJnPlh59QOJlJ96vCgM/edit?usp=sharing",
        active: true
      },
      {
        name: "ãƒ‘ãƒ«ãƒˆãƒ»ãƒ—ãƒ­ãƒ ãƒŠãƒ¼ãƒ‰â… ",
        position: { lat: 35.0099677, lng: 135.9655099 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1Z0DdHhCUaoCQRBgKckEN8bohvAyx5Zfg_6Awqn8y3_s/edit?usp=sharing",
        active: true
      },
      {
        name: "ãƒ‘ãƒ«ãƒˆãƒ»ãƒ—ãƒ­ãƒ ãƒŠãƒ¼ãƒ‰â…¡",
        position: { lat: 35.0100723, lng: 135.9654017 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1-FAask5Li3iYGb1UUjKhDvCf4UKUAX3vxtxLV73yFIs/edit?usp=sharing",
        active: true
      },
      {
        name: "EL ORIENTE",
        position: { lat: 35.0137968, lng: 135.9714161 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1Pv1OciAaztZCIBkIyCxO46pHIErr5dWZJnRgCB00NcI/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚³ã‚¹ãƒ¢è‰æ´¥(å¤œ)",
        position: { lat: 35.0173991, lng: 135.9598398 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1o4RwGf_t96GtdFDp7jNkVDMSFr22Vhz3-ScqZ9wOoDc/edit?usp=sharing",
        active: true
      },
      {
        name: "è‰æ´¥ãƒ‘ãƒ¼ã‚¯ãƒ›ãƒ¼ãƒ ã‚º",
        position: { lat: 35.0122945, lng: 135.9559939 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1ThqZh2LcPcwXBIP630vr3b_ZCR26-npxVy_-347ORRY/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚³ã‚³ã‚¹ãƒ¢è‰æ´¥â…¡ (å¤œ)",
        position: { lat: 35.0176379, lng: 135.9587089 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1M8uhi42_NvaVrYCA59XLDuCrLYcn5t8XlrLv-g8-dEI/edit?usp=sharing",
        active: true
      },
      {
        name: "ãƒªãƒ™ãƒ«ãƒ†è‰æ´¥",
        position: { lat: 35.018516, lng: 135.9591753 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1bVCC-vuvmNAqsKfs3mvRXWGhKCE7XHeAFeJ_nwWRzWA/edit?usp=sharing",
        active: true
      },
      {
        name: "ã‚¢ã‚³ãƒ¼ãƒ«æ±è‰æ´¥",
        position: { lat: 35.0157344, lng: 135.9690205 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1rAz961SDxo0Q028rR0fBV8nyPq5A1RQeawZE34nZJFA/edit?usp=sharing",
        active: true
      },
      {
        name: "Casa raffineè‰æ´¥",
        position: { lat: 35.0151292, lng: 135.9645046 },
        sheetUrl: "https://docs.google.com/spreadsheets/d/1WGYDKJQj28mxtCNOBP3MVInTkD0yVOvfirfHZkh6ZHk/edit?usp=sharing",
        active: true
      }
    ];

    /* ==========================================
       Google ãƒãƒƒãƒ—åˆæœŸåŒ–
       ========================================== */
    let map;
    let userMarker = null;

    function initMap() {
      map = new google.maps.Map(document.getElementById("map"), {
        center: { lat: 35.00, lng: 135.97 },
        zoom: 14,
      });

      // ãƒãƒ¼ã‚«ãƒ¼æç”»
      apartments.forEach((apt) => loadApartmentMarker(apt));

      // ç¾åœ¨åœ°ãƒœã‚¿ãƒ³
      document.getElementById("getLocationBtn").addEventListener("click", getLocation);
    }

    /* ==========================================
       ãƒãƒ¼ã‚«ãƒ¼ã® Pathï¼ˆå®Œå…¨ç‰ˆä¿®æ­£æ¸ˆã¿ï¼‰
       ========================================== */
    const pathData =
      "M1662.11,944.38c0-306.13-248.18-554.32-554.32-554.32-29.74,0-58.89,2.36-87.35,6.92-264.64,41.86-466.93,271.01-466.93,547.4,0,85.15,19.19,165.84,53.57,237.93,15.53,32.7,34.27,63.56,55.63,92.33h-.11l445.23,590.94,441.56-586.19h-.07c70.74-93.08,112.79-209.13,112.79-335.02ZM1107.8,1193.08c-99.14,0-184.7-57.99-224.65-141.94-15.45-32.36-24.06-68.57-24.06-106.77,0-124.05,90.76-226.86,209.54-245.64,12.76-2.06,25.85-3.11,39.17-3.11,137.37,0,248.75,111.37,248.75,248.75s-111.37,248.71-248.75,248.71Z";

    /* ==========================================
       ãƒãƒ¼ã‚«ãƒ¼ã‚¢ã‚¤ã‚³ãƒ³ã‚’å‹•çš„ç”Ÿæˆã™ã‚‹é–¢æ•°
       ========================================== */
    function createMarkerIcon(color) {
      return {
        path: pathData,
        fillColor: color,
        fillOpacity: 1,
        strokeWeight: 1,
        strokeColor: "#333",
        scale: 0.02,
        anchor: new google.maps.Point(500, 1500)
      };
    }

    /* ==========================================
       Google ã‚·ãƒ¼ãƒˆ CSV ã‚’èª­ã¿è¾¼ã¿ â†’ è‰²ã‚’æ±ºå®š
       ========================================== */
    async function loadApartmentMarker(apt) {
      // ã‚¢ã‚¯ãƒ†ã‚£ãƒ–ã§ãªã„ï¼ˆéå¯¾è±¡ï¼‰ã¯é»„ç·‘
      if (!apt.active || !apt.sheetUrl) {
        placeMarker(apt, "limegreen");
        return;
      }

      try {
        const csvUrl = apt.sheetUrl.replace("/edit?usp=sharing", "/export?format=csv");
        const res = await fetch(csvUrl);
        const text = await res.text();
        const rows = text.split("\n").map((r) => r.split(","));

        // åˆ—åè¡Œã‚’å–å¾—
        const header = rows[0];
        const visitCol = header.indexOf("è¨ªå•çŠ¶æ³");
        const meetCol = header.indexOf("ä¼šãˆãŸ");

        let total = 0;
        let firstCount = 0;
        let meetCount = 0;

        // === ä¿®æ­£æ¸ˆã¿ï¼štrim ã‚’å¿…ãšé©ç”¨ ===
        for (let i = 1; i < rows.length; i++) {
          const v = rows[i][visitCol]?.trim();
          const m = rows[i][meetCol]?.trim();

          if (!v && !m) continue;

          total++;
          if (v === "ä¸€å›ç›®") firstCount++;
          if (m === "ä¼šãˆãŸ") meetCount++;
        }

        /* ***********************************
           ğŸŸ¡ æ­£ã—ã„å„ªå…ˆé †ä½ã§è‰²ã‚’æ±ºå®š
           1) å…¨éƒ¨ä¸€å›ç›® â†’ é»„è‰²
           2) ä¼šãˆãŸ50%ä»¥ä¸Š â†’ èµ¤
           3) ãã‚Œä»¥å¤– â†’ é»„ç·‘
        *********************************** */
        let color;
        if (total > 0 && firstCount === total) {
          color = "yellow";
        } else if (total > 0 && meetCount / total >= 0.5) {
          color = "red";
        } else {
          color = "limegreen";
        }

        placeMarker(apt, color);

      } catch (e) {
        console.error("ã‚·ãƒ¼ãƒˆå–å¾—å¤±æ•—:", apt.name, e);
        placeMarker(apt, "gray");
      }
    }

    /* ==========================================
       ãƒãƒ¼ã‚«ãƒ¼ä½œæˆ
       ========================================== */
    function placeMarker(apt, color) {
      new google.maps.Marker({
        position: apt.position,
        map,
        title: apt.name,
        icon: createMarkerIcon(color),
      });
    }

    /* ==========================================
       ç¾åœ¨åœ°ã‚’å–å¾—ã—ã¦ãƒãƒ¼ã‚«ãƒ¼è¡¨ç¤º
       ========================================== */
    function getLocation() {
      if (!navigator.geolocation) {
        alert("ã“ã®ãƒ–ãƒ©ã‚¦ã‚¶ã§ã¯ç¾åœ¨åœ°å–å¾—ãŒã‚µãƒãƒ¼ãƒˆã•ã‚Œã¦ã„ã¾ã›ã‚“ã€‚");
        return;
      }

      navigator.geolocation.getCurrentPosition(
        (pos) => {
          const lat = pos.coords.latitude;
          const lng = pos.coords.longitude;

          const userPos = { lat, lng };

          // ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ãŒã™ã§ã«ã‚ã‚‹å ´åˆ â†’ ç§»å‹•
          if (userMarker) {
            userMarker.setPosition(userPos);
          } else {
            // æ–°è¦ä½œæˆ
            userMarker = new google.maps.Marker({
              position: userPos,
              map,
              title: "ç¾åœ¨åœ°",
              icon: {
                path: google.maps.SymbolPath.CIRCLE,
                scale: 14,
                fillColor: "#4285F4",
                fillOpacity: 1,
                strokeColor: "white",
                strokeWeight: 3,
              },
            });

            // ã‚†ã£ãã‚Šé¼“å‹•ã™ã‚‹ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
            animateUserMarker();
          }

          map.panTo(userPos);
        },
        (err) => {
          alert("ç¾åœ¨åœ°ã‚’å–å¾—ã§ãã¾ã›ã‚“ã§ã—ãŸï¼š" + err.message);
        }
      );
    }

    /* ==========================================
       ç¾åœ¨åœ°ãƒãƒ¼ã‚«ãƒ¼ã‚’ã‚†ã£ãã‚Šé¼“å‹•ã•ã›ã‚‹
       ========================================== */
    function animateUserMarker() {
      if (!userMarker) return;

      let growing = true;
      let scale = 14;

      setInterval(() => {
        if (!userMarker) return;

        if (growing) {
          scale += 0.25;
          if (scale >= 18) growing = false;
        } else {
          scale -= 0.25;
          if (scale <= 14) growing = true;
        }

        userMarker.setIcon({
          path: google.maps.SymbolPath.CIRCLE,
          scale,
          fillColor: "#4285F4",
          fillOpacity: 1,
          strokeColor: "white",
          strokeWeight: 3,
        });
      }, 80); // â† ã‚†ã£ãã‚Šãƒªã‚ºãƒ ã«èª¿æ•´
    }

  </script>
</body>
</html>
